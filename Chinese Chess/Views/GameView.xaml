<UserControl x:Name="Root" x:Class="Chinese_Chess.Views.GameView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:local="clr-namespace:Chinese_Chess.Helpers" 
      mc:Ignorable="d"
      d:DesignHeight="700" d:DesignWidth="1100">

    <UserControl.Resources>
        <local:BoardCoordinateConverter x:Key="PosConverter"/>
        <local:BoolToVisibilityConverter x:Key="VisConverter"/>
        <Style x:Key="ModernScrollBarStyle" TargetType="ScrollBar">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Width" Value="1"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ScrollBar">
                        <Grid x:Name="Root" Background="Transparent" SnapsToDevicePixels="True">
                            <Track x:Name="PART_Track" IsDirectionReversed="true">
                                <Track.Thumb>
                                    <Thumb>
                                        <Thumb.Template>
                                            <ControlTemplate TargetType="Thumb">
                                                <Border x:Name="ThumbBorder" 
                                                    Background="#CCC" 
                                                    CornerRadius="4" 
                                                    Margin="1,0"/>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="ThumbBorder" Property="Background" Value="#A1887F"/>
                                                    </Trigger>
                                                    <Trigger Property="IsDragging" Value="True">
                                                        <Setter TargetName="ThumbBorder" Property="Background" Value="#8D6E63"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Thumb.Template>
                                    </Thumb>
                                </Track.Thumb>
                            </Track>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>

    <UserControl.Background>
        <ImageBrush ImageSource="/Assets/Background/background.png" Stretch="UniformToFill"/>
    </UserControl.Background>

    <Viewbox Stretch="Uniform">
        <Grid x:Name="MainLayout" Width="1100" Height="700">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="670"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            <Button x:Name="GoBackButton" Grid.Row="0" 
                    HorizontalAlignment="Left" Width="35" Height="31"
                    Background="Transparent" BorderThickness="0" 
                    Cursor="Hand" Click="GoBack_Click" ToolTip="Về màn hình chính" VerticalAlignment="Top">
                <Image Source="/Assets/Button/GoBack.png" Stretch="Fill"/>
            </Button>

            <Grid x:Name="BoardLayout" Grid.Column="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <Label x:Name="GameTimerLabel" Content="00:00" Grid.Row="0" 
                       FontSize="20" FontWeight="Bold" 
                       HorizontalAlignment="Center" VerticalAlignment="Top"
                       Margin="0,0,0,0"/>


                <Viewbox Grid.Row="1" Stretch="Uniform" Margin="0,5">
                    <Grid Width="600" Height="640">
                        <Image x:Name="BoardImage" Source="/Assets/XiangquiBoard.png" Stretch="Fill"/>
                        <ItemsControl ItemsSource="{Binding Pieces}" Width="600" Height="640">
                            
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <Canvas x:Name="BoardCanvas" Background="Transparent" MouseDown="BoardCanvas_MouseDown"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>

                            <ItemsControl.ItemContainerStyle>
                                <Style TargetType="ContentPresenter">
                                    <Setter Property="Canvas.Left" Value="{Binding X, Converter={StaticResource PosConverter}, ConverterParameter=X}"/>
                                    <Setter Property="Canvas.Top" Value="{Binding Y, Converter={StaticResource PosConverter}, ConverterParameter=Y}"/>
                                </Style>
                            </ItemsControl.ItemContainerStyle>

                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Grid Visibility="{Binding IsAlive, Converter={StaticResource VisConverter}}">

                                        <Ellipse Width="55" Height="55" Stroke="Yellow" StrokeThickness="3" 
                                            HorizontalAlignment="Center" VerticalAlignment="Center" Margin="-2.5,-2.5,0,0"
                                            Visibility="{Binding IsSelected, Converter={StaticResource VisConverter}}">
                                            <Ellipse.Effect>
                                                <BlurEffect Radius="5"/>
                                            </Ellipse.Effect>
                                        </Ellipse>

                                        <Image Source="{Binding ImagePath}" Width="50" Height="50" Cursor="Hand"
                                        HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                        

                        <ItemsControl ItemsSource="{Binding ValidMoves}" Width="600" Height="640" IsHitTestVisible="False">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <Canvas/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemContainerStyle>
                                <Style TargetType="ContentPresenter">
                                    <Setter Property="Canvas.Left" Value="{Binding X, Converter={StaticResource PosConverter}, ConverterParameter=X}"/>
                                    <Setter Property="Canvas.Top" Value="{Binding Y, Converter={StaticResource PosConverter}, ConverterParameter=Y}"/>
                                </Style>
                            </ItemsControl.ItemContainerStyle>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Grid Width="60" Height="60" Margin="-5,-5,0,0">
                                        <Ellipse Width="30" Height="30" Fill="#BF94E4" Opacity="0.4" 
                                            HorizontalAlignment="Center" VerticalAlignment="Center">
                                            <Ellipse.Effect>
                                                <BlurEffect Radius="8"/>
                                            </Ellipse.Effect>
                                        </Ellipse>
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                    </Grid>
                </Viewbox>

                <UniformGrid x:Name="ControlBarPanel" Grid.Row="2" Rows="1" Width="600" 
                             HorizontalAlignment="Center" VerticalAlignment="Center" Margin="0,0,0,5">

                    <Button x:Name="Backward" Background="Transparent" BorderThickness="0" Click="Backward_Click">
                        <StackPanel>
                            <Image Source="/Assets/Button/backward1.png" Height="30" HorizontalAlignment="Center"/>
                            <TextBlock Text="Lùi lại" FontSize="12" FontWeight="SemiBold" HorizontalAlignment="Center" Margin="0,2,0,0"/>
                        </StackPanel>
                    </Button>

                    <Button x:Name="Pause" Background="Transparent" BorderThickness="0" Click="Pause_Click">
                        <StackPanel>
                            <Image x:Name="Pause_icon" Source="/Assets/Button/pause1.png" Height="30" HorizontalAlignment="Center"/>
                            <TextBlock Text="Tạm dừng" FontSize="12" FontWeight="SemiBold" HorizontalAlignment="Center" Margin="0,2,0,0"/>
                        </StackPanel>
                    </Button>

                    <Button x:Name="Forward" Background="Transparent" BorderThickness="0" Click="Forward_Click">
                        <StackPanel>
                            <Image Source="/Assets/Button/backward1.png" Height="30" HorizontalAlignment="Center" RenderTransformOrigin="0.5,0.5">
                                <Image.RenderTransform>
                                    <ScaleTransform ScaleX="-1"/>
                                </Image.RenderTransform>
                            </Image>
                            <TextBlock Text="Đi tiếp" FontSize="12" FontWeight="SemiBold" HorizontalAlignment="Center" Margin="0,2,0,0"/>
                        </StackPanel>
                    </Button>

                    <Button x:Name="New_Game" Background="Transparent" BorderThickness="0" Click="New_Game_Click">
                        <StackPanel>
                            <Image Source="/Assets/Button/renew1.png" Height="30" HorizontalAlignment="Center"/>
                            <TextBlock Text="Ván mới" FontSize="12" FontWeight="SemiBold" HorizontalAlignment="Center" Margin="0,2,0,0"/>
                        </StackPanel>
                    </Button>

                    <Button x:Name="Draw_offer" Background="Transparent" BorderThickness="0" 
                            IsEnabled="False" Opacity="0.5" 
                            ToolTip="Bot chưa được cài đặt tính năng cầu hòa">
                        <StackPanel>
                            <Image Source="/Assets/Button/draw10.png" Height="30" HorizontalAlignment="Center"/>
                            <TextBlock Text="Cầu hòa" FontSize="12" FontWeight="SemiBold" HorizontalAlignment="Center" Margin="0,2,0,0"/>
                        </StackPanel>
                    </Button>

                    <Button x:Name="Surrender" Background="Transparent" BorderThickness="0" Click="SurrenderButton_Click">
                        <StackPanel>
                            <Image Source="/Assets/Button/surrender10.png" Height="30" HorizontalAlignment="Center"/>
                            <TextBlock Text="Đầu hàng" FontSize="12" FontWeight="SemiBold" HorizontalAlignment="Center" Margin="0,2,0,0"/>
                        </StackPanel>
                    </Button>
                </UniformGrid>
            </Grid>

            <Grid Grid.Column="1" Margin="20,10,20,10">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <StackPanel Grid.Row="0" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,0,10">
                    <Button x:Name="MuteButton" Width="35" Height="35" Margin="0,0,10,0" Background="Transparent" BorderThickness="0" Click="MuteButton_Click">
                        <Image x:Name="SoundIcon" Source="/Assets/Button/sound_on.png"/>
                    </Button>
                    <Button x:Name="Settings" Width="35" Height="35" Background="Transparent" BorderThickness="0" Click="SettingsButton_Click">
                        <Image Source="/Assets/Button/setting.png"/>
                    </Button>
                </StackPanel>

                <StackPanel x:Name="SidePanel" Grid.Row="1" VerticalAlignment="Center">

                    <Border x:Name="Player1Card" Height="140" Margin="0,0,0,15" Background="#FDF8F0" CornerRadius="10">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="BorderBrush" Value="#DDD"/>
                                <Setter Property="BorderThickness" Value="1"/>
                                <Setter Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect Color="Gray" BlurRadius="5" ShadowDepth="2" Opacity="0.3"/>
                                    </Setter.Value>
                                </Setter>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding GameStatus}" Value="Lượt Đen">
                                        <Setter Property="BorderBrush" Value="Orange"/>
                                        <Setter Property="BorderThickness" Value="3"/>
                                        <Setter Property="Effect">
                                            <Setter.Value>
                                                <DropShadowEffect Color="Orange" BlurRadius="15" ShadowDepth="0" Opacity="0.8"/>
                                            </Setter.Value>
                                        </Setter>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>

                        <Grid Margin="10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Image x:Name="Player1_avatar" Source="/Assets/ImagePiece/black_general.png" Width="70" Height="70" VerticalAlignment="Top"/>
                            <StackPanel Grid.Column="1" Margin="10,0,0,0">
                                <TextBlock x:Name="Player1_name" Text="Bot Hard" FontWeight="Bold" FontSize="18"/>
                                <TextBlock x:Name="Player1_elo" Text="Elo: 2800" Foreground="Gray" Margin="0,5,0,0"/>
                            </StackPanel>
                            <WrapPanel x:Name="P1CapturedList" Grid.ColumnSpan="2" VerticalAlignment="Bottom" Margin="0,5,0,0">
                                <TextBlock Text="Đã ăn: " Foreground="Silver" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                <ItemsControl ItemsSource="{Binding CapturedRedPieces}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Image Source="{Binding ImagePath}" Width="25" Margin="1"/>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </WrapPanel>
                        </Grid>
                    </Border>

                    <Border x:Name="Player2Card" Height="140" Margin="0,0,0,15" Background="#FDF8F0" CornerRadius="10">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="BorderBrush" Value="#DDD"/>
                                <Setter Property="BorderThickness" Value="1"/>
                                <Setter Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect Color="Gray" BlurRadius="5" ShadowDepth="2" Opacity="0.3"/>
                                    </Setter.Value>
                                </Setter>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding GameStatus}" Value="Lượt Đỏ">
                                        <Setter Property="BorderBrush" Value="Orange"/>
                                        <Setter Property="BorderThickness" Value="3"/>
                                        <Setter Property="Effect">
                                            <Setter.Value>
                                                <DropShadowEffect Color="Orange" BlurRadius="15" ShadowDepth="0" Opacity="0.8"/>
                                            </Setter.Value>
                                        </Setter>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>

                        <Grid Margin="10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Image x:Name="Player2_avatar" Source="/Assets/ImagePiece/red_general.png" Width="70" Height="70" VerticalAlignment="Top"/>
                            <StackPanel Grid.Column="1" Margin="10,0,0,0">
                                <TextBlock x:Name="Player2_name" Text="Player 1" FontWeight="Bold" FontSize="18"/>
                                <TextBlock x:Name="Player2_elo" Text="Elo: 1200" Foreground="Gray" Margin="0,5,0,0"/>
                            </StackPanel>
                            <WrapPanel x:Name="P2CapturedList" Grid.ColumnSpan="2" VerticalAlignment="Bottom" Margin="0,5,0,0">
                                <TextBlock Text="Đã ăn: " Foreground="Silver" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                <ItemsControl ItemsSource="{Binding CapturedBlackPieces}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Image Source="{Binding ImagePath}" Width="25" Margin="1"/>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </WrapPanel>
                        </Grid>
                    </Border>

                    <Border x:Name="ChatBoxCard" Height="220" Background="#FDF8F0" BorderBrush="#DDD" BorderThickness="1" CornerRadius="10">
                        <Border.Effect>
                            <DropShadowEffect Color="Gray" BlurRadius="5" ShadowDepth="2" Opacity="0.3"/>
                        </Border.Effect>

                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <ScrollViewer x:Name="ChatHistoryScroll" Margin="10" VerticalScrollBarVisibility="Auto">
                                <ScrollViewer.Resources>
                                    <Style TargetType="ScrollBar" BasedOn="{StaticResource ModernScrollBarStyle}"/>
                                </ScrollViewer.Resources>
                                <ItemsControl ItemsSource="{Binding ChatMessages}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Margin="0,4">
                                                <Border x:Name="Bubble" Padding="10,6" CornerRadius="8" MaxWidth="200">
                                                    <StackPanel>
                                                        <TextBlock x:Name="SenderName" Text="{Binding Sender}" 
                                                        FontSize="9" Foreground="Gray" Margin="0,0,0,2" Visibility="Collapsed"/>

                                                        <TextBlock Text="{Binding Text}" TextWrapping="Wrap" FontSize="13"/>

                                                        <TextBlock Text="{Binding TimeDisplay}" 
                                                           FontSize="9" 
                                                           Foreground="#888" 
                                                           HorizontalAlignment="Right" 
                                                           Margin="5,2,0,0"/>
                                                    </StackPanel>
                                                </Border>
                                            </Grid>

                                            <DataTemplate.Triggers>
                                                <DataTrigger Binding="{Binding Type}" Value="Player">
                                                    <Setter TargetName="Bubble" Property="HorizontalAlignment" Value="Right"/>
                                                    <Setter TargetName="Bubble" Property="Background" Value="#DCF8C6"/>
                                                    <Setter TargetName="Bubble" Property="BorderBrush" Value="#C4E1A4"/>
                                                    <Setter TargetName="Bubble" Property="BorderThickness" Value="1"/>
                                                </DataTrigger>

                                                <DataTrigger Binding="{Binding Type}" Value="Bot">
                                                    <Setter TargetName="Bubble" Property="HorizontalAlignment" Value="Left"/>
                                                    <Setter TargetName="Bubble" Property="Background" Value="White"/>
                                                    <Setter TargetName="Bubble" Property="BorderBrush" Value="#DDD"/>
                                                    <Setter TargetName="Bubble" Property="BorderThickness" Value="1"/>
                                                    <Setter TargetName="SenderName" Property="Visibility" Value="Visible"/>
                                                </DataTrigger>

                                                <DataTrigger Binding="{Binding Type}" Value="System">
                                                    <Setter TargetName="Bubble" Property="HorizontalAlignment" Value="Center"/>
                                                    <Setter TargetName="Bubble" Property="Background" Value="Transparent"/>
                                                    <Setter TargetName="Bubble" Property="Padding" Value="0"/>
                                                    <Setter TargetName="Bubble" Property="TextBlock.FontStyle" Value="Italic"/>
                                                    <Setter TargetName="Bubble" Property="TextBlock.Foreground" Value="Gray"/>
                                                </DataTrigger>
                                            </DataTemplate.Triggers>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>

                            <Grid Grid.Row="1" Margin="10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBox x:Name="ChatInputBox" Height="30" VerticalContentAlignment="Center" Padding="5,0" 
                                Background="White" BorderBrush="#CCC" KeyDown="ChatInputBox_KeyDown"/>
                                <Button x:Name="SendButton" Grid.Column="1" Width="30" Height="30" Margin="5,0,0,0" 
                                Background="Transparent" BorderThickness="0" Click="SendButton_Click" Cursor="Hand">
                                    <Image Source="/Assets/Button/send_icon.png" Stretch="Uniform"/>
                                </Button>
                            </Grid>
                        </Grid>
                    </Border>
                </StackPanel>

                <TextBlock x:Name="RealTimeClock" Grid.Row="2" Text="Loading..." 
                           FontSize="12" Foreground="#FFD91E1E" FontWeight="SemiBold"
                           HorizontalAlignment="Right" VerticalAlignment="Bottom" 
                           Margin="0,5,0,0"/>
            </Grid>
        </Grid>
    </Viewbox>
</UserControl>